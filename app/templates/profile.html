{% extends "base.html" %}

{% block title %}Profile — Felker Family Hub{% endblock %}

{% block content %}
<div x-data="profileApp" x-init="loadProfile()" x-cloak>

    <!-- Header: avatar, name, level, XP bar -->
    <section class="profile-header">
        <div class="profile-avatar icon-particle-host" id="profile-icon-preview">
            <!-- Emoji always visible as base fallback layer -->
            <span x-text="iconDisplay(profileIcon)" class="avatar-emoji-base"></span>
            <!-- Lottie overlaid on top (transparent when placeholder, covers emoji when real) -->
            <template x-if="currentIconMeta && currentIconMeta.lottie">
                <lottie-player :src="currentIconMeta.lottie_src" background="transparent"
                               speed="1" autoplay loop>
                </lottie-player>
            </template>
        </div>
        <div class="profile-info">
            <div class="profile-username" x-text="username"></div>
            <div class="profile-level-badge">
                <span class="profile-level" x-text="'Lv' + level"></span>
                <span class="profile-level-name" x-text="levelName"></span>
            </div>
            <div class="xp-bar">
                <div class="xp-bar-fill" :style="'width:' + progressPct + '%'"></div>
            </div>
            <div class="xp-bar-label" x-text="xp + ' / ' + (nextLevelXp || 'MAX') + ' XP'"></div>
        </div>
    </section>

    <!-- Stats row -->
    <section class="profile-stats-row">
        <div class="profile-stat">
            <div class="profile-stat-value">
                <span x-text="streakCurrent"></span>
                <template x-if="fireMode">
                    <span class="fire-badge">&#128293; FIRE</span>
                </template>
            </div>
            <div class="profile-stat-label">Current Streak</div>
        </div>
        <div class="profile-stat">
            <div class="profile-stat-value" x-text="streakBest"></div>
            <div class="profile-stat-label">Best Streak</div>
        </div>
        <div class="profile-stat">
            <div class="profile-stat-value" x-text="achievementsUnlocked + '/14'"></div>
            <div class="profile-stat-label">Achievements</div>
        </div>
    </section>

    <!-- Achievement showcase -->
    <section class="profile-section">
        <div class="section-header">
            <h2 class="section-title">Achievements</h2>
            <button class="btn-ghost btn-sm" @click="showAllAchievements = !showAllAchievements"
                    x-text="showAllAchievements ? 'Show Recent' : 'Show All'"></button>
        </div>

        <!-- Recent 3 -->
        <div class="achievement-grid" x-show="!showAllAchievements">
            <template x-for="a in recentAchievements" :key="a.id">
                <div class="achievement-card achievement-unlocked" :class="'achievement-' + a.tier">
                    <div class="achievement-card-icon" x-text="a.icon"></div>
                    <div class="achievement-card-name" x-text="a.name"></div>
                    <div class="achievement-card-xp" x-text="'+' + a.xp_reward + ' XP'"></div>
                </div>
            </template>
            <div x-show="recentAchievements.length === 0" class="empty-state">
                No achievements yet — start completing chores!
            </div>
        </div>

        <!-- Full catalog -->
        <div x-show="showAllAchievements">
            <template x-for="cat in ['chores', 'streaks', 'bank']" :key="cat">
                <div class="achievement-category">
                    <h3 class="achievement-category-title" x-text="cat.charAt(0).toUpperCase() + cat.slice(1)"></h3>
                    <div class="achievement-grid">
                        <template x-for="a in catalogByCategory(cat)" :key="a.id">
                            <div class="achievement-card" :class="{
                                'achievement-unlocked': a.unlocked,
                                'achievement-locked': !a.unlocked,
                                ['achievement-' + a.tier]: true
                            }">
                                <div class="achievement-card-icon" :class="{ 'achievement-icon-locked': !a.unlocked }"
                                     x-text="a.icon"></div>
                                <div class="achievement-card-name" x-text="a.name"></div>
                                <template x-if="a.unlocked">
                                    <div class="achievement-card-xp" x-text="'+' + a.xp_reward + ' XP'"></div>
                                </template>
                                <template x-if="!a.unlocked">
                                    <div class="achievement-card-req" x-text="a.description"></div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Icon selector -->
    <section class="profile-section">
        <h2 class="section-title">Choose Your Icon</h2>
        <div class="icon-grid">
            <template x-for="icon in availableIcons" :key="icon.id">
                <button class="icon-btn"
                        :class="{
                            'icon-selected': profileIcon === icon.id,
                            'icon-locked': icon.locked,
                            [icon.css_class]: icon.css_class && !icon.locked
                        }"
                        @click="!icon.locked && selectIcon(icon.id)"
                        :disabled="icon.locked">
                    <!-- Emoji always visible as base fallback layer -->
                    <span x-text="icon.emoji" class="avatar-emoji-base"></span>
                    <!-- Lottie overlaid on top for unlocked L5+ icons -->
                    <template x-if="icon.lottie && !icon.locked">
                        <lottie-player :src="icon.lottie_src" background="transparent"
                                       speed="1" autoplay loop>
                        </lottie-player>
                    </template>
                    <span class="icon-lock" x-show="icon.locked" x-text="'Lv' + icon.min_level"></span>
                </button>
            </template>
        </div>
    </section>

    <!-- Theme color picker -->
    <section class="profile-section">
        <h2 class="section-title">Theme Color</h2>
        <div class="theme-swatch-grid">
            <template x-for="t in themeColors" :key="t.name">
                <button class="theme-swatch" :class="{
                    'swatch-selected': currentTheme === t.name,
                    'swatch-locked': level < t.unlock_level
                }"
                        :style="'--swatch-color:' + t.hex"
                        @click="level >= t.unlock_level && selectTheme(t.name)"
                        :disabled="level < t.unlock_level">
                    <div class="swatch-fill"></div>
                    <span class="swatch-lock" x-show="level < t.unlock_level"
                          x-text="'Lv' + t.unlock_level"></span>
                    <span class="swatch-name" x-text="t.name"></span>
                </button>
            </template>
        </div>
    </section>

    <!-- Flash message -->
    <div class="bank-flash" x-show="flashMsg" x-cloak
         x-transition :class="flashType" x-text="flashMsg"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('profileApp', () => ({
        // Profile data
        username: '',
        profileIcon: 'star_basic',
        level: 1,
        levelName: 'Rookie',
        xp: 0,
        nextLevelXp: 200,
        progressPct: 0,
        streakCurrent: 0,
        streakBest: 0,
        fireMode: false,
        achievementsUnlocked: 0,
        currentTheme: 'cyan',
        // UI state
        showAllAchievements: false,
        flashMsg: '',
        flashType: 'success',
        // Achievement data
        recentAchievements: [],
        catalog: [],
        // Icon data — list of dicts from API
        availableIcons: [],

        // Computed: metadata for the currently selected icon
        get currentIconMeta() {
            return this.availableIcons.find(i => i.id === this.profileIcon) || null;
        },

        // Display the emoji for an icon ID (fallback for non-Lottie icons)
        iconDisplay(id) {
            const meta = this.availableIcons.find(i => i.id === id);
            if (meta) return meta.emoji;
            return id; // passthrough for legacy emoji icons
        },

        themeColors: [
            { name: 'cyan',    hex: '#00d4ff', unlock_level: 1 },
            { name: 'blue',    hex: '#3366ff', unlock_level: 1 },
            { name: 'purple',  hex: '#8338ec', unlock_level: 1 },
            { name: 'lime',    hex: '#39ff14', unlock_level: 3 },
            { name: 'magenta', hex: '#ff006e', unlock_level: 3 },
            { name: 'gold',    hex: '#ffd700', unlock_level: 5 },
            { name: 'red',     hex: '#ff3333', unlock_level: 7 },
        ],

        async loadProfile() {
            try {
                const res = await fetch('/api/profile');
                if (!res.ok) return;
                const data = await res.json();

                this.username = data.username;
                this.profileIcon = data.icon;
                this.level = data.level;
                this.levelName = data.level_name;
                this.xp = data.xp;
                this.nextLevelXp = data.next_level_xp;
                this.progressPct = data.progress_pct;
                this.streakCurrent = data.streak_current;
                this.streakBest = data.streak_best;
                this.fireMode = data.fire_mode;
                this.currentTheme = data.theme_color;
                this.availableIcons = data.available_icons || [];

                // Load achievements
                this.achievementsUnlocked = data.achievements_unlocked || 0;
                this.recentAchievements = data.recent_achievements || [];

                // Load full catalog
                const catRes = await fetch('/api/achievements/catalog');
                if (catRes.ok) {
                    const catData = await catRes.json();
                    this.catalog = catData.achievements || [];
                }

                // Initialize particles for currently selected icon if L8+
                this.$nextTick(() => {
                    if (this.level >= 8 && typeof initProfileParticle === 'function') {
                        initProfileParticle(this.profileIcon);
                    }
                });
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        },

        catalogByCategory(cat) {
            return this.catalog.filter(a => a.category === cat);
        },

        async selectIcon(icon) {
            try {
                const res = await fetch('/api/profile/icon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ icon })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                this.profileIcon = icon;
                this.flash('Icon updated!', 'success');
                // Update particle effect for new icon
                if (this.level >= 8 && typeof initProfileParticle === 'function') {
                    this.$nextTick(() => initProfileParticle(icon));
                }
            } catch (e) {
                this.flash('Failed to update icon', 'error');
            }
        },

        async selectTheme(theme) {
            try {
                const res = await fetch('/api/profile/theme', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme_color: theme })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                this.currentTheme = theme;
                // Update body class immediately
                document.body.className = document.body.className.replace(/theme-\w+/, 'theme-' + theme);
                this.flash('Theme updated!', 'success');
            } catch (e) {
                this.flash('Failed to update theme', 'error');
            }
        },

        flash(msg, type = 'success') {
            this.flashMsg = msg;
            this.flashType = type;
            setTimeout(() => { this.flashMsg = ''; }, 3000);
        }
    }));
});
</script>
{% endblock %}
