{% extends "base.html" %}

{% block title %}Profile â€” Felker Family Hub{% endblock %}

{% block content %}
<div x-data="profileApp" x-init="loadProfile()" x-cloak>

    <!-- Header: avatar, name, level, XP bar -->
    <section class="profile-header">
        <div class="profile-avatar icon-particle-host" id="profile-icon-preview">
            <!-- Emoji always visible as base fallback layer -->
            <span x-text="iconDisplay(profileIcon)" class="avatar-emoji-base"></span>
            <!-- Lottie overlaid on top (transparent when placeholder, covers emoji when real) -->
            <template x-if="currentIconMeta && currentIconMeta.lottie">
                <lottie-player :src="currentIconMeta.lottie_src" background="transparent"
                               speed="1" autoplay loop>
                </lottie-player>
            </template>
        </div>
        <div class="profile-info">
            <div class="profile-username" x-text="username"></div>
            <div class="profile-level-badge">
                <span class="profile-level" x-text="'Lv' + level"></span>
                <span class="profile-level-name" x-text="levelName"></span>
            </div>
            <div class="xp-bar">
                <div class="xp-bar-fill" :style="'width:' + progressPct + '%'"></div>
            </div>
            <div class="xp-bar-label" x-text="xp + ' / ' + (nextLevelXp || 'MAX') + ' XP'"></div>
        </div>
    </section>

    <!-- Stats row -->
    <section class="profile-stats-row">
        <div class="profile-stat">
            <div class="profile-stat-value">
                <span x-text="streakCurrent"></span>
                <template x-if="fireMode">
                    <span class="fire-badge">&#128293; FIRE</span>
                </template>
            </div>
            <div class="profile-stat-label">Current Streak</div>
        </div>
        <div class="profile-stat">
            <div class="profile-stat-value" x-text="streakBest"></div>
            <div class="profile-stat-label">Best Streak</div>
        </div>
        <div class="profile-stat">
            <div class="profile-stat-value" x-text="achievementsUnlocked + '/14'"></div>
            <div class="profile-stat-label">Achievements</div>
        </div>
    </section>

    <!-- Achievement showcase -->
    <section class="profile-section">
        <div class="section-header">
            <h2 class="section-title">Achievements</h2>
            <button class="btn-ghost btn-sm" @click="showAllAchievements = !showAllAchievements"
                    x-text="showAllAchievements ? 'Show Recent' : 'Show All'"></button>
        </div>

        <!-- Recent 3 -->
        <div class="achievement-grid" x-show="!showAllAchievements">
            <template x-for="a in recentAchievements" :key="a.id">
                <div class="achievement-card achievement-unlocked" :class="'achievement-' + a.tier">
                    <div class="achievement-card-icon" x-text="a.icon"></div>
                    <div class="achievement-card-name" x-text="a.name"></div>
                    <div class="achievement-card-xp" x-text="'+' + a.xp_reward + ' XP'"></div>
                </div>
            </template>
            <div x-show="recentAchievements.length === 0" class="empty-state">
                No achievements yet â€” start completing chores!
            </div>
        </div>

        <!-- Full catalog -->
        <div x-show="showAllAchievements">
            <template x-for="cat in ['chores', 'streaks', 'bank']" :key="cat">
                <div class="achievement-category">
                    <h3 class="achievement-category-title" x-text="cat.charAt(0).toUpperCase() + cat.slice(1)"></h3>
                    <div class="achievement-grid">
                        <template x-for="a in catalogByCategory(cat)" :key="a.id">
                            <div class="achievement-card" :class="{
                                'achievement-unlocked': a.unlocked,
                                'achievement-locked': !a.unlocked,
                                ['achievement-' + a.tier]: true
                            }">
                                <div class="achievement-card-icon" :class="{ 'achievement-icon-locked': !a.unlocked }"
                                     x-text="a.icon"></div>
                                <div class="achievement-card-name" x-text="a.name"></div>
                                <template x-if="a.unlocked">
                                    <div class="achievement-card-xp" x-text="'+' + a.xp_reward + ' XP'"></div>
                                </template>
                                <template x-if="!a.unlocked">
                                    <div class="achievement-card-req" x-text="a.description"></div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Icon selector -->
    <section class="profile-section">
        <h2 class="section-title">Choose Your Icon</h2>
        <div class="icon-grid">
            <template x-for="icon in availableIcons" :key="icon.id">
                <button class="icon-btn"
                        :class="{
                            'icon-selected': profileIcon === icon.id,
                            'icon-locked': icon.locked,
                            [icon.css_class]: icon.css_class && !icon.locked
                        }"
                        @click="!icon.locked && selectIcon(icon.id)"
                        :disabled="icon.locked">
                    <!-- Emoji always visible as base fallback layer -->
                    <span x-text="icon.emoji" class="avatar-emoji-base"></span>
                    <!-- Lottie overlaid on top for unlocked L5+ icons -->
                    <template x-if="icon.lottie && !icon.locked">
                        <lottie-player :src="icon.lottie_src" background="transparent"
                                       speed="1" autoplay loop>
                        </lottie-player>
                    </template>
                    <span class="icon-lock" x-show="icon.locked" x-text="'Lv' + icon.min_level"></span>
                </button>
            </template>
        </div>
    </section>

    <!-- Theme color picker -->
    <section class="profile-section">
        <h2 class="section-title">Theme Color</h2>
        <div class="theme-swatch-grid">
            <template x-for="t in themeColors" :key="t.name">
                <button class="theme-swatch" :class="{
                    'swatch-selected': currentTheme === t.name,
                    'swatch-locked': level < t.unlock_level
                }"
                        :style="'--swatch-color:' + t.hex"
                        @click="level >= t.unlock_level && selectTheme(t.name)"
                        :disabled="level < t.unlock_level">
                    <div class="swatch-fill"></div>
                    <span class="swatch-lock" x-show="level < t.unlock_level"
                          x-text="'Lv' + t.unlock_level"></span>
                    <span class="swatch-name" x-text="t.name"></span>
                </button>
            </template>
        </div>
    </section>

    <!-- Mission Gems -->
    <section class="profile-section" x-show="completedMissions.length > 0" x-cloak>
        <h2 class="section-title">&#128142; Mission Gems</h2>
        <div class="gem-trophy-grid">
            <template x-for="(m, i) in completedMissions" :key="i">
                <div class="gem-trophy-card" :class="'gem-card-' + (m.gem_type || 'diamond')">
                    <!-- CSS-rendered gem -->
                    <div class="gem-visual-wrap">
                        <div class="gem-shape"
                             :class="['gem-' + (m.gem_type || 'diamond'), 'gem-' + (m.gem_size || 'medium')]">
                        </div>
                    </div>
                    <div class="gem-mission-title" x-text="m.mission_title"></div>
                    <div class="gem-size-label" x-show="m.gem_size"
                         x-text="(m.gem_size || '').charAt(0).toUpperCase() + (m.gem_size || '').slice(1) + ' ' + (m.gem_type || '')"></div>
                    <div class="gem-desc" x-show="m.reward_description"
                         x-text="m.reward_description"></div>
                </div>
            </template>
        </div>
    </section>

    <!-- Lifestyle Goals Management -->
    <section class="profile-section">
        <div class="lifestyle-section-header">
            <div class="lifestyle-header-left">
                <span class="lifestyle-header-icon">&#127807;</span>
                <h2 class="lifestyle-header-title">Lifestyle Goals</h2>
            </div>
            <button class="btn-ghost btn-sm" @click="showGoalForm = !showGoalForm"
                    x-text="showGoalForm ? 'Cancel' : '+ New Goal'"></button>
        </div>

        <!-- New goal form -->
        <div x-show="showGoalForm" x-cloak class="lifestyle-new-goal-form">
            <div class="lifestyle-form-row">
                <div class="lifestyle-form-field">
                    <label class="lifestyle-form-label">What habit would you like to form?</label>
                    <input type="text" x-model="newGoalName" placeholder="e.g. Read 20 minutes"
                           class="form-input" @keydown.enter="createGoal()">
                </div>
                <div class="lifestyle-form-field lifestyle-form-field-narrow">
                    <label class="lifestyle-form-label">How many times a week?</label>
                    <input type="number" x-model.number="newGoalTarget"
                           class="form-input" min="1" max="7" @keydown.enter="createGoal()">
                </div>
            </div>
            <button class="btn-log-goal" @click="createGoal()"
                    :disabled="!newGoalName.trim() || !newGoalTarget || newGoalTarget < 1">
                &#10004; Add This Goal
            </button>
        </div>

        <!-- Goals grid (same card style as Today page) -->
        <div x-show="lifestyleGoals.length === 0 && !showGoalForm" class="lifestyle-empty">
            No goals yet â€” tap "+ New Goal" to add one!
        </div>

        <div class="lifestyle-goals-grid" x-show="lifestyleGoals.length > 0">
            <template x-for="goal in lifestyleGoals" :key="goal.id">
                <div class="lifestyle-goal-card" :class="{'goal-complete': goal.on_track, 'goal-logged': goal.today_logged}">
                    <div class="goal-complete-badge" x-show="goal.on_track">&#10003;</div>

                    <!-- View mode -->
                    <template x-if="editingGoalId !== goal.id">
                        <div class="goal-card-name" x-text="goal.name"></div>
                    </template>
                    <!-- Edit mode: replace name with input -->
                    <template x-if="editingGoalId === goal.id">
                        <input type="text" x-model="editGoalName" class="form-input goal-edit-name-input"
                               @keydown.enter="saveGoal(goal.id)">
                    </template>

                    <!-- Tally -->
                    <div class="goal-tally-row">
                        <div class="goal-tally-block">
                            <div class="goal-tally-num" x-text="goal.this_week_count"></div>
                            <div class="goal-tally-label">This week</div>
                        </div>
                        <div class="goal-tally-divider">/</div>
                        <div class="goal-tally-block">
                            <template x-if="editingGoalId !== goal.id">
                                <div class="goal-tally-num goal-tally-target" x-text="goal.weekly_target"></div>
                            </template>
                            <template x-if="editingGoalId === goal.id">
                                <input type="number" x-model.number="editGoalTarget"
                                       class="form-input goal-edit-target-input"
                                       min="1" max="7">
                            </template>
                            <div class="goal-tally-label">Goal</div>
                        </div>
                    </div>

                    <!-- Progress dots -->
                    <div class="goal-dots-row">
                        <template x-for="i in goal.weekly_target" :key="i">
                            <div class="goal-dot" :class="{'goal-dot-filled': i <= goal.this_week_count}"></div>
                        </template>
                    </div>

                    <!-- Actions -->
                    <div class="goal-manage-actions">
                        <template x-if="editingGoalId !== goal.id">
                            <button class="btn-goal-action btn-goal-edit" @click="startEditGoal(goal)">Edit</button>
                        </template>
                        <template x-if="editingGoalId === goal.id">
                            <button class="btn-goal-action btn-goal-save" @click="saveGoal(goal.id)">Save</button>
                        </template>
                        <button class="btn-goal-action btn-goal-remove" @click="deactivateGoal(goal.id)">Remove</button>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <!-- Privilege Redemptions -->
    <section class="profile-section" x-show="allRedemptions.length > 0" x-cloak>
        <h2 class="section-title">Redemption History</h2>
        <template x-for="r in allRedemptions" :key="r.id">
            <div class="lifestyle-redemption-row">
                <div class="redemption-info">
                    <span class="redemption-priv" x-text="r.privilege_name"></span>
                    <span class="redemption-pts" x-text="r.points_spent + ' pts'"></span>
                    <span class="redemption-date" x-text="formatDate(r.redeemed_at)"></span>
                </div>
                <div class="redemption-status">
                    <span class="redemption-badge" :class="'status-' + r.status" x-text="r.status"></span>
                    <button x-show="r.status === 'pending'" class="btn-ghost btn-sm btn-danger"
                            @click="cancelRedemption(r.id)">Cancel</button>
                </div>
            </div>
        </template>
    </section>

    <!-- Admin Panel entry (admin-only) -->
    <template x-if="isAdmin">
      <section class="profile-section">
        <div class="admin-entry">
          <a href="/admin" class="btn-admin-panel">&#9881; Admin Panel</a>
        </div>
      </section>
    </template>

    <!-- Flash message -->
    <div class="bank-flash" x-show="flashMsg" x-cloak
         x-transition :class="flashType" x-text="flashMsg"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('profileApp', () => ({
        // Profile data
        username: '',
        profileIcon: 'star_basic',
        level: 1,
        levelName: 'Rookie',
        xp: 0,
        nextLevelXp: 200,
        progressPct: 0,
        streakCurrent: 0,
        streakBest: 0,
        fireMode: false,
        achievementsUnlocked: 0,
        currentTheme: 'cyan',
        isAdmin: false,
        // UI state
        showAllAchievements: false,
        flashMsg: '',
        flashType: 'success',
        // Achievement data
        recentAchievements: [],
        catalog: [],
        // Icon data â€” list of dicts from API
        availableIcons: [],
        // Mission gems
        completedMissions: [],
        // Lifestyle goals
        lifestyleGoals: [],
        lifestylePoints: 0,
        showGoalForm: false,
        newGoalName: '',
        newGoalTarget: 7,
        editingGoalId: null,
        editGoalName: '',
        editGoalTarget: 7,
        // Redemptions
        allRedemptions: [],

        // Computed: metadata for the currently selected icon
        get currentIconMeta() {
            return this.availableIcons.find(i => i.id === this.profileIcon) || null;
        },

        // Display the emoji for an icon ID (fallback for non-Lottie icons)
        iconDisplay(id) {
            const meta = this.availableIcons.find(i => i.id === id);
            if (meta) return meta.emoji;
            return id; // passthrough for legacy emoji icons
        },

        themeColors: [
            { name: 'cyan',    hex: '#00d4ff', unlock_level: 1 },
            { name: 'blue',    hex: '#3366ff', unlock_level: 1 },
            { name: 'purple',  hex: '#8338ec', unlock_level: 1 },
            { name: 'lime',    hex: '#39ff14', unlock_level: 3 },
            { name: 'magenta', hex: '#ff006e', unlock_level: 3 },
            { name: 'gold',    hex: '#ffd700', unlock_level: 5 },
            { name: 'red',     hex: '#ff3333', unlock_level: 7 },
        ],

        async loadProfile() {
            try {
                const res = await fetch('/api/profile');
                if (!res.ok) return;
                const data = await res.json();

                this.username = data.username;
                this.profileIcon = data.icon;
                this.level = data.level;
                this.levelName = data.level_name;
                this.xp = data.xp;
                this.nextLevelXp = data.next_level_xp;
                this.progressPct = data.progress_pct;
                this.streakCurrent = data.streak_current;
                this.streakBest = data.streak_best;
                this.fireMode = data.fire_mode;
                this.currentTheme = data.theme_color;
                this.isAdmin = data.is_admin || false;
                this.availableIcons = data.available_icons || [];
                this.completedMissions = data.completed_missions || [];
                this.lifestylePoints = data.lifestyle_points || 0;

                // Load achievements
                this.achievementsUnlocked = data.achievements_unlocked || 0;
                this.recentAchievements = data.recent_achievements || [];

                // Load full catalog
                const catRes = await fetch('/api/achievements/catalog');
                if (catRes.ok) {
                    const catData = await catRes.json();
                    this.catalog = catData.achievements || [];
                }

                // Load lifestyle goals and redemptions
                this.loadLifestyleGoals();
                this.loadRedemptions();

                // Initialize particles for currently selected icon if L8+
                this.$nextTick(() => {
                    if (this.level >= 8 && typeof initProfileParticle === 'function') {
                        initProfileParticle(this.profileIcon);
                    }
                });
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        },

        catalogByCategory(cat) {
            return this.catalog.filter(a => a.category === cat);
        },

        async selectIcon(icon) {
            try {
                const res = await fetch('/api/profile/icon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ icon })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                this.profileIcon = icon;
                this.flash('Icon updated!', 'success');
                // Update particle effect for new icon
                if (this.level >= 8 && typeof initProfileParticle === 'function') {
                    this.$nextTick(() => initProfileParticle(icon));
                }
            } catch (e) {
                this.flash('Failed to update icon', 'error');
            }
        },

        async selectTheme(theme) {
            try {
                const res = await fetch('/api/profile/theme', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ theme_color: theme })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                this.currentTheme = theme;
                // Update body class immediately
                document.body.className = document.body.className.replace(/theme-\w+/, 'theme-' + theme);
                this.flash('Theme updated!', 'success');
            } catch (e) {
                this.flash('Failed to update theme', 'error');
            }
        },

        gemEmoji(gemType) {
            const map = { ruby: 'ðŸ”´', emerald: 'ðŸ’š', diamond: 'ðŸ’Ž', sapphire: 'ðŸ”µ', amethyst: 'ðŸ’œ', topaz: 'ðŸŸ¡' };
            return map[gemType] || 'ðŸ’Ž';
        },

        async loadLifestyleGoals() {
            try {
                const res = await fetch('/api/lifestyle/goals');
                if (!res.ok) return;
                const data = await res.json();
                this.lifestyleGoals = data.goals || [];
            } catch (e) {}
        },

        async createGoal() {
            if (!this.newGoalName.trim() || !this.newGoalTarget || this.newGoalTarget < 1) return;
            try {
                const res = await fetch('/api/lifestyle/goals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: this.newGoalName.trim(), weekly_target: this.newGoalTarget })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                this.lifestyleGoals.push(data);
                this.newGoalName = '';
                this.newGoalTarget = 7;
                this.showGoalForm = false;
                this.flash('Goal added!', 'success');
            } catch (e) { this.flash('Failed to add goal', 'error'); }
        },

        startEditGoal(goal) {
            this.editingGoalId = goal.id;
            this.editGoalName = goal.name;
            this.editGoalTarget = goal.weekly_target;
        },

        async saveGoal(goalId) {
            try {
                const res = await fetch(`/api/lifestyle/goals/${goalId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: this.editGoalName.trim(), weekly_target: this.editGoalTarget })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                const idx = this.lifestyleGoals.findIndex(g => g.id === goalId);
                if (idx >= 0) this.lifestyleGoals[idx] = data;
                this.editingGoalId = null;
                this.flash('Goal updated!', 'success');
            } catch (e) { this.flash('Failed to update goal', 'error'); }
        },

        async deactivateGoal(goalId) {
            try {
                const res = await fetch(`/api/lifestyle/goals/${goalId}`, { method: 'DELETE' });
                if (!res.ok) return;
                this.lifestyleGoals = this.lifestyleGoals.filter(g => g.id !== goalId);
                this.flash('Goal removed', 'success');
            } catch (e) { this.flash('Failed to remove goal', 'error'); }
        },

        async loadRedemptions() {
            try {
                const res = await fetch('/api/lifestyle/redemptions');
                if (!res.ok) return;
                const data = await res.json();
                this.allRedemptions = data.redemptions || [];
            } catch (e) {}
        },

        async cancelRedemption(redemptionId) {
            try {
                const res = await fetch(`/api/lifestyle/redemptions/${redemptionId}/cancel`, { method: 'POST' });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }
                const idx = this.allRedemptions.findIndex(r => r.id === redemptionId);
                if (idx >= 0) this.allRedemptions[idx].status = 'cancelled';
                this.lifestylePoints += data.points_refunded || 0;
                this.flash('Redemption cancelled â€” points refunded', 'success');
            } catch (e) { this.flash('Failed to cancel redemption', 'error'); }
        },

        formatDate(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        flash(msg, type = 'success') {
            this.flashMsg = msg;
            this.flashType = type;
            setTimeout(() => { this.flashMsg = ''; }, 3000);
        }
    }));
});
</script>
{% endblock %}
