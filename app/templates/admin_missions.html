{% extends "base.html" %}

{% block title %}Admin â€” Missions{% endblock %}

{% block content %}
<div x-data="adminMissionsApp()" x-init="init()" class="admin-missions-container">

  <h1 class="page-title">Mission Admin</h1>

  <!-- Assign Mission -->
  <div class="admin-missions-section">
    <h2 class="section-title">Assign Mission</h2>
    <div class="assign-form">
      <select x-model="selectedUser" class="form-select">
        <option value="">Select user...</option>
        <template x-for="u in users" :key="u.id">
          <option :value="u.id" x-text="u.username"></option>
        </template>
      </select>
      <select x-model="selectedMission" class="form-select">
        <option value="">Select mission...</option>
        <template x-for="m in missions" :key="m.id">
          <option :value="m.id" x-text="m.title"></option>
        </template>
      </select>
      <button class="btn btn-accent" @click="assignMission()" :disabled="!selectedUser || !selectedMission">Assign</button>
    </div>
    <p x-show="assignMessage" x-text="assignMessage" class="assign-message" :class="assignError ? 'error' : 'success'"></p>
  </div>

  <!-- Mission Catalog / Rewards -->
  <div class="admin-missions-section">
    <h2 class="section-title">Mission Rewards</h2>
    <template x-if="missions.length === 0">
      <p class="empty-text">No missions defined. Create missions first.</p>
    </template>
    <div class="mission-catalog-list">
      <template x-for="m in missions" :key="m.id">
        <div class="mission-catalog-card">
          <div class="mission-catalog-header">
            <div class="mission-catalog-title">
              <strong x-text="m.title"></strong>
              <span class="mission-type-badge" x-text="m.mission_type"></span>
            </div>
            <div class="mission-catalog-summary">
              <span x-show="m.reward_cash > 0" class="reward-cash-pill" x-text="'$' + Number(m.reward_cash).toFixed(2)"></span>
              <span class="reward-xp-pill" x-text="'+' + (m.reward_xp || 500) + ' XP'"></span>
              <span x-show="m.gem_type" class="reward-gem-pill" x-text="gemEmoji(m.gem_type) + ' ' + (m.gem_size || '') + ' ' + (m.gem_type || '')"></span>
            </div>
            <button class="btn btn-sm btn-outline" @click="toggleEdit(m)">
              <span x-text="editingMissionId === m.id ? 'Cancel' : 'Edit Rewards'"></span>
            </button>
          </div>

          <!-- Inline edit form -->
          <div x-show="editingMissionId === m.id" x-cloak class="mission-reward-edit-form">
            <div class="reward-edit-row">
              <label class="reward-edit-label">Cash Reward ($)</label>
              <input type="number" x-model.number="editForm.reward_cash" class="form-input reward-xp-input" min="0" step="0.25" placeholder="0.00">
            </div>
            <div class="reward-edit-row">
              <label class="reward-edit-label">XP Reward</label>
              <input type="number" x-model.number="editForm.reward_xp" class="form-input reward-xp-input" min="0" step="50" placeholder="500">
            </div>
            <div class="reward-edit-row">
              <label class="reward-edit-label">Reward Description</label>
              <input type="text" x-model="editForm.reward_description" class="form-input" placeholder="You earned this gem byâ€¦" maxlength="300">
            </div>
            <div class="reward-edit-row">
              <label class="reward-edit-label">Gem Type <span class="required-star">*</span></label>
              <select x-model="editForm.gem_type" class="form-select">
                <option value="">â€” select gem â€”</option>
                <option value="ruby">ðŸ”´ Ruby</option>
                <option value="emerald">ðŸ’š Emerald</option>
                <option value="diamond">ðŸ’Ž Diamond</option>
                <option value="sapphire">ðŸ”µ Sapphire</option>
                <option value="amethyst">ðŸ’œ Amethyst</option>
                <option value="topaz">ðŸŸ¡ Topaz</option>
              </select>
            </div>
            <div class="reward-edit-row">
              <label class="reward-edit-label">Gem Size <span class="required-star">*</span></label>
              <select x-model="editForm.gem_size" class="form-select">
                <option value="">â€” select size â€”</option>
                <option value="small">Small</option>
                <option value="medium">Medium</option>
                <option value="large">Large</option>
              </select>
            </div>
            <div class="reward-edit-actions">
              <button class="btn btn-accent btn-sm" @click="saveMissionEdit(m.id)" :disabled="!editForm.gem_type || !editForm.gem_size">Save Rewards</button>
              <p x-show="editMessage" x-text="editMessage" class="assign-message" :class="editError ? 'error' : 'success'"></p>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Pending Approvals -->
  <div class="admin-missions-section" x-show="pendingApprovals.length > 0">
    <h2 class="section-title">Pending Approvals</h2>
    <div class="approval-list">
      <template x-for="a in pendingApprovals" :key="a.id">
        <div class="approval-card">
          <div class="approval-info">
            <strong x-text="getUserName(a.user_id)"></strong>
            <span> â€” </span>
            <span x-text="getMissionTitle(a.mission_id)"></span>
          </div>
          <div class="approval-actions">
            <button class="btn btn-accent btn-sm" @click="approve(a.id)">Approve</button>
            <button class="btn btn-danger btn-sm" @click="reject(a.id)">Reject</button>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- All Assignments -->
  <div class="admin-missions-section">
    <h2 class="section-title">All Assignments</h2>
    <template x-if="assignments.length === 0">
      <p class="empty-text">No missions assigned yet.</p>
    </template>
    <div class="assignments-list">
      <template x-for="a in assignments" :key="a.id">
        <div class="assignment-row">
          <span class="assignment-user" x-text="getUserName(a.user_id)"></span>
          <span class="assignment-mission" x-text="getMissionTitle(a.mission_id)"></span>
          <span class="state-badge" :class="'badge-' + a.state" x-text="a.state"></span>
          <span class="assignment-level" x-text="'L' + a.current_level" x-show="a.current_level > 0"></span>
          <button
            x-show="a.state === 'completed'"
            class="btn btn-danger btn-sm"
            @click="undoCompletion(a.id, getUserName(a.user_id), getMissionTitle(a.mission_id))">
            Undo
          </button>
        </div>
      </template>
    </div>
  </div>

  <!-- Undo Confirmation Modal -->
  <div x-show="undoConfirm.visible" x-cloak class="modal-overlay" @click.self="undoConfirm.visible = false">
    <div class="modal-card">
      <h3 class="modal-title">Undo Mission Completion?</h3>
      <p class="modal-body">
        This will revert <strong x-text="undoConfirm.username"></strong>'s completion of
        <strong x-text="undoConfirm.missionTitle"></strong>.<br>
        XP and cash rewards will be deducted (may go negative). Gems will be removed from their profile.
      </p>
      <div class="modal-actions">
        <button class="btn btn-danger" @click="confirmUndo()">Yes, Undo</button>
        <button class="btn btn-outline" @click="undoConfirm.visible = false">Cancel</button>
      </div>
    </div>
  </div>

</div>

<script>
function adminMissionsApp() {
  return {
    missions: [],
    assignments: [],
    users: [],
    selectedUser: '',
    selectedMission: '',
    assignMessage: '',
    assignError: false,

    // Mission reward editing
    editingMissionId: null,
    editForm: { reward_cash: 0, reward_xp: 500, reward_description: '', gem_type: '', gem_size: '' },
    editMessage: '',
    editError: false,

    // Undo confirmation
    undoConfirm: { visible: false, assignmentId: null, username: '', missionTitle: '' },

    get pendingApprovals() {
      return this.assignments.filter(a => a.state === 'pending_approval');
    },

    async init() {
      await this.load();
    },

    async load() {
      try {
        const resp = await fetch('/api/admin/missions');
        const data = await resp.json();
        this.missions = data.missions || [];
        this.assignments = data.assignments || [];
        this.users = data.users || [];
      } catch (e) {
        console.error('Failed to load admin data:', e);
      }
    },

    getUserName(userId) {
      const u = this.users.find(u => u.id === userId);
      return u ? u.username : 'Unknown';
    },

    getMissionTitle(missionId) {
      const m = this.missions.find(m => m.id === missionId);
      return m ? m.title : 'Unknown';
    },

    gemEmoji(gemType) {
      const map = { ruby: 'ðŸ”´', emerald: 'ðŸ’š', diamond: 'ðŸ’Ž', sapphire: 'ðŸ”µ', amethyst: 'ðŸ’œ', topaz: 'ðŸŸ¡' };
      return map[gemType] || 'ðŸ’Ž';
    },

    toggleEdit(mission) {
      if (this.editingMissionId === mission.id) {
        this.editingMissionId = null;
        this.editMessage = '';
      } else {
        this.editingMissionId = mission.id;
        this.editMessage = '';
        this.editError = false;
        this.editForm = {
          reward_cash: mission.reward_cash || 0,
          reward_xp: mission.reward_xp || 500,
          reward_description: mission.reward_description || '',
          gem_type: mission.gem_type || '',
          gem_size: mission.gem_size || '',
        };
      }
    },

    async saveMissionEdit(missionId) {
      this.editMessage = '';
      this.editError = false;
      try {
        const resp = await fetch(`/api/admin/missions/${missionId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            reward_cash: this.editForm.reward_cash,
            reward_xp: this.editForm.reward_xp,
            reward_description: this.editForm.reward_description,
            gem_type: this.editForm.gem_type,
            gem_size: this.editForm.gem_size,
          }),
        });
        const data = await resp.json();
        if (resp.ok) {
          this.editMessage = 'Rewards saved!';
          this.editError = false;
          await this.load();
          // Re-open edit panel on updated mission
          const updated = this.missions.find(m => m.id === missionId);
          if (updated) {
            this.editForm = {
              reward_cash: updated.reward_cash || 0,
              reward_xp: updated.reward_xp || 500,
              reward_description: updated.reward_description || '',
              gem_type: updated.gem_type || '',
              gem_size: updated.gem_size || '',
            };
          }
          this.editingMissionId = missionId;
        } else {
          this.editMessage = data.error || 'Failed to save';
          this.editError = true;
        }
      } catch (e) {
        this.editMessage = 'Network error';
        this.editError = true;
      }
    },

    undoCompletion(assignmentId, username, missionTitle) {
      this.undoConfirm = { visible: true, assignmentId, username, missionTitle };
    },

    async confirmUndo() {
      const id = this.undoConfirm.assignmentId;
      this.undoConfirm.visible = false;
      try {
        const resp = await fetch(`/api/admin/missions/${id}/undo`, { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) {
          alert(data.error || 'Undo failed');
        }
        await this.load();
      } catch (e) {
        alert('Network error during undo');
      }
    },

    async assignMission() {
      this.assignMessage = '';
      try {
        const resp = await fetch('/api/admin/missions/assign', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            mission_id: parseInt(this.selectedMission),
            user_id: parseInt(this.selectedUser),
          }),
        });
        const data = await resp.json();
        if (resp.ok) {
          this.assignMessage = 'Mission assigned!';
          this.assignError = false;
          this.selectedUser = '';
          this.selectedMission = '';
          await this.load();
        } else {
          this.assignMessage = data.error || 'Failed to assign';
          this.assignError = true;
        }
      } catch (e) {
        this.assignMessage = 'Network error';
        this.assignError = true;
      }
    },

    async approve(id) {
      try {
        await fetch(`/api/admin/missions/${id}/approve`, {method: 'POST'});
        await this.load();
      } catch (e) {
        console.error('Approve failed:', e);
      }
    },

    async reject(id) {
      try {
        await fetch(`/api/admin/missions/${id}/reject`, {method: 'POST'});
        await this.load();
      } catch (e) {
        console.error('Reject failed:', e);
      }
    },
  };
}
</script>
{% endblock %}
