<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% block title %}Felker Family Hub{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2.3.4">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    {% block head %}{% endblock %}
</head>
<body class="theme-{{ current_user.theme_color if current_user else 'cyan' }}"
      data-level="{{ current_user.level if current_user else 1 }}"
      data-fire-mode="{{ 'true' if current_user and current_user.fire_mode else 'false' }}"
      x-data="app"
      @visibilitychange.window="handleVisibility()">

    {% block body %}
    <!-- Page content -->
    <div class="page-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="flash-msg {{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Bottom nav bar -->
    {% if current_user %}
    <nav class="bottom-nav">
        <a href="/calendar" class="nav-item {% if active_nav == 'calendar' %}active{% endif %}">
            <span class="nav-icon">&#128197;</span>
            Calendar
        </a>
        <a href="/chores-page" class="nav-item {% if active_nav == 'chores' %}active{% endif %}">
            <span class="nav-icon">&#9989;</span>
            Chores
        </a>
        <a href="/grocery-page" class="nav-item {% if active_nav == 'grocery' %}active{% endif %}">
            <span class="nav-icon">&#128722;</span>
            Grocery
        </a>
        <a href="/bank" class="nav-item {% if active_nav == 'bank' %}active{% endif %}">
            <span class="nav-icon">&#128176;</span>
            Bank
        </a>
        <a href="/missions" class="nav-item {% if active_nav == 'missions' %}active{% endif %}">
            <span class="nav-icon">&#127942;</span>
            Missions
        </a>
        <a href="/profile" class="nav-item {% if active_nav == 'profile' %}active{% endif %}">
            <span class="nav-icon">&#128100;</span>
            Profile
        </a>

        <!-- Available to cash out ticker -->
        <span class="nav-ticker" x-text="tickerDisplay">$0.000000</span>

        <!-- Current user + switch -->
        <a href="/session/logout" class="nav-user">
            <span class="nav-user-avatar {{ current_user.icon | icon_css }}">{{ current_user.icon | icon_emoji }}</span>
            <span>{{ current_user.username }}</span>
            <span class="nav-level-badge">Lv{{ current_user.level }}</span>
        </a>
    </nav>
    {% endif %}
    {% endblock %}

    <!-- Mission notification modal -->
    {% if current_user %}
    <template x-if="missionNotifications.length > 0">
      <div class="mission-notification-overlay" @click="dismissMissionNotifications()">
        <div class="mission-notification-modal" @click.stop>
          <span class="notification-trophy">&#127942;</span>
          <div class="notification-title">New Mission Assigned!</div>
          <template x-for="n in missionNotifications" :key="n.id">
            <span class="notification-mission-name" x-text="n.mission?.title"></span>
          </template>
          <div class="notification-actions">
            <a href="/missions" class="btn btn-accent">Go to Missions</a>
            <button class="btn btn-secondary" @click="dismissMissionNotifications()">Later</button>
          </div>
        </div>
      </div>
    </template>

    <!-- Achievement toast (bronze) -->
    <template x-if="currentAchievement && currentAchievement.tier === 'bronze'">
      <div class="achievement-toast" @click="_dismissCurrentAchievement()">
        <div class="achievement-toast-icon" x-text="currentAchievement.icon"></div>
        <div class="achievement-toast-body">
          <div class="achievement-toast-title" x-text="currentAchievement.name"></div>
          <div class="achievement-toast-desc" x-text="currentAchievement.description"></div>
          <div class="achievement-toast-xp" x-text="'+' + currentAchievement.xp_reward + ' XP'"></div>
        </div>
      </div>
    </template>

    <!-- Achievement banner (silver) -->
    <template x-if="currentAchievement && currentAchievement.tier === 'silver'">
      <div class="achievement-banner" @click="_dismissCurrentAchievement()">
        <div class="achievement-banner-icon" x-text="currentAchievement.icon"></div>
        <div class="achievement-banner-body">
          <div class="achievement-banner-label">Achievement Unlocked!</div>
          <div class="achievement-banner-title" x-text="currentAchievement.name"></div>
          <div class="achievement-banner-desc" x-text="currentAchievement.description"></div>
          <div class="achievement-banner-xp" x-text="'+' + currentAchievement.xp_reward + ' XP'"></div>
        </div>
      </div>
    </template>

    <!-- Achievement fullscreen (gold) -->
    <template x-if="currentAchievement && currentAchievement.tier === 'gold'">
      <div class="achievement-fullscreen" @click="_dismissCurrentAchievement()">
        <div class="achievement-fullscreen-card">
          <div class="achievement-fullscreen-particles"></div>
          <div class="achievement-fullscreen-label">LEGENDARY ACHIEVEMENT</div>
          <div class="achievement-fullscreen-icon" x-text="currentAchievement.icon"></div>
          <div class="achievement-fullscreen-title" x-text="currentAchievement.name"></div>
          <div class="achievement-fullscreen-desc" x-text="currentAchievement.description"></div>
          <div class="achievement-fullscreen-xp" x-text="'+' + currentAchievement.xp_reward + ' XP'"></div>
          <div class="achievement-fullscreen-hint">Tap to dismiss</div>
        </div>
      </div>
    </template>

    <!-- Level-up overlay -->
    <template x-if="levelUpData">
      <div class="levelup-overlay" @click="levelUpData = null">
        <div class="levelup-card">
          <div class="levelup-label">LEVEL UP!</div>
          <div class="levelup-level" x-text="'Level ' + levelUpData.new_level"></div>
          <div class="levelup-name" x-text="levelUpData.level_name"></div>
          <div class="levelup-hint">Tap to continue</div>
        </div>
      </div>
    </template>

    <!-- Fire Mode activation overlay -->
    <template x-if="showFireMode">
      <div class="fire-mode-overlay" @click="showFireMode = false">
        <div class="fire-mode-card">
          <div class="fire-mode-flames">&#128293;&#128293;&#128293;</div>
          <div class="fire-mode-label">FIRE MODE ACTIVATED!</div>
          <div class="fire-mode-desc">+50% Allowance Bonus</div>
          <div class="fire-mode-streak" x-text="'Week ' + fireModeStreak + ' streak!'"></div>
          <div class="fire-mode-hint">Tap to continue</div>
        </div>
      </div>
    </template>
    {% endif %}

    {% block scripts %}{% endblock %}

    <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('app', () => ({
            tickerDisplay: '$0.000000',
            _tickerSavings: 0,
            _tickerRate: 0.05,
            _tickerLastCredit: null,
            _tickerCashBalance: 0,
            _tickerUnlockedSavings: 0,
            _tickerRaf: null,
            idleTimer: null,
            idleTimeout: {{ idle_timeout_ms|default(300000) }},
            missionNotifications: [],
            // Achievement notifications
            achievementQueue: [],
            currentAchievement: null,
            showingAchievement: false,
            levelUpData: null,
            showFireMode: false,
            fireModeStreak: 0,

            init() {
                this.resetIdleTimer();
                document.addEventListener('pointerdown', () => this.resetIdleTimer());
                document.addEventListener('keydown', () => this.resetIdleTimer());

                {% if current_user %}
                this._startNavTicker();
                setInterval(() => this._syncNavTicker(), 30000);
                this._checkMissionNotifications();
                this._checkAchievementNotifications();
                {% endif %}
            },

            async _startNavTicker() {
                try {
                    const res = await fetch('/api/bank/ticker');
                    if (!res.ok) return;
                    const data = await res.json();
                    this._tickerSavings = data.total_active_savings;
                    this._tickerRate = data.weekly_rate;
                    this._tickerLastCredit = data.last_interest_credit ? new Date(data.last_interest_credit) : null;
                    this._tickerCashBalance = data.cash_balance || 0;
                    this._tickerUnlockedSavings = data.unlocked_savings || 0;
                    if (this._tickerRaf) cancelAnimationFrame(this._tickerRaf);
                    this._tickNavTicker();
                } catch (e) {}
            },

            _tickNavTicker() {
                let interest = 0;
                if (this._tickerSavings > 0 && this._tickerLastCredit) {
                    const elapsed = (new Date() - this._tickerLastCredit) / 1000;
                    interest = this._tickerSavings * this._tickerRate * (elapsed / (7*24*60*60));
                }
                const total = this._tickerCashBalance + this._tickerUnlockedSavings + interest;
                this.tickerDisplay = '$' + total.toFixed(6);
                this._tickerRaf = requestAnimationFrame(() => this._tickNavTicker());
            },

            async _syncNavTicker() {
                try {
                    const res = await fetch('/api/bank/ticker');
                    if (!res.ok) return;
                    const data = await res.json();
                    this._tickerSavings = data.total_active_savings;
                    this._tickerRate = data.weekly_rate;
                    this._tickerLastCredit = data.last_interest_credit ? new Date(data.last_interest_credit) : null;
                    this._tickerCashBalance = data.cash_balance || 0;
                    this._tickerUnlockedSavings = data.unlocked_savings || 0;
                } catch (e) {}
            },

            resetIdleTimer() {
                clearTimeout(this.idleTimer);
                this.idleTimer = setTimeout(() => {
                    window.location.href = '/session/logout';
                }, this.idleTimeout);
            },

            handleVisibility() {
                if (document.visibilityState === 'visible') {
                    this.resetIdleTimer();
                }
            },

            async _checkMissionNotifications() {
                try {
                    const res = await fetch('/api/missions/notifications');
                    if (!res.ok) return;
                    const data = await res.json();
                    this.missionNotifications = data.notifications || [];
                } catch (e) {}
            },

            async dismissMissionNotifications() {
                try {
                    await fetch('/api/missions/notifications/dismiss', { method: 'POST' });
                } catch (e) {}
                this.missionNotifications = [];
            },

            async _checkAchievementNotifications() {
                try {
                    const res = await fetch('/api/achievements/notifications');
                    if (!res.ok) return;
                    const data = await res.json();
                    const notifications = data.notifications || [];
                    if (notifications.length === 0) return;

                    // Build queue from achievement data, gold first (API already sorts)
                    this.achievementQueue = notifications.map(n => n.achievement);
                    this._showNextAchievement();
                } catch (e) {}
            },

            _showNextAchievement() {
                if (this.achievementQueue.length === 0) {
                    this.currentAchievement = null;
                    this.showingAchievement = false;
                    return;
                }
                this.currentAchievement = this.achievementQueue.shift();
                this.showingAchievement = true;

                // Auto-dismiss after tier-appropriate timeout
                const timeouts = { bronze: 3000, silver: 5000, gold: 8000 };
                const timeout = timeouts[this.currentAchievement.tier] || 3000;
                setTimeout(() => {
                    if (this.showingAchievement) {
                        this._dismissCurrentAchievement();
                    }
                }, timeout);
            },

            async _dismissCurrentAchievement() {
                if (!this.currentAchievement) return;
                try {
                    await fetch('/api/achievements/notifications/dismiss', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ achievement_ids: [this.currentAchievement.id] })
                    });
                } catch (e) {}
                this.currentAchievement = null;
                this.showingAchievement = false;
                // Show next after brief pause
                setTimeout(() => this._showNextAchievement(), 500);
            },

            _showLevelUp(data) {
                this.levelUpData = data;
                setTimeout(() => { this.levelUpData = null; }, 5000);
            },

            _showFireModeActivation(streak) {
                this.fireModeStreak = streak;
                this.showFireMode = true;
                setTimeout(() => { this.showFireMode = false; }, 8000);
            }
        }));
    });
    </script>
</body>
</html>
