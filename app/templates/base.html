<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% block title %}Felker Family Hub{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2.2.1">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    {% block head %}{% endblock %}
</head>
<body class="theme-{{ current_user.theme_color if current_user else 'cyan' }}"
      x-data="app"
      @visibilitychange.window="handleVisibility()">

    {% block body %}
    <!-- Page content -->
    <div class="page-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="flash-msg {{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Bottom nav bar -->
    {% if current_user %}
    <nav class="bottom-nav">
        <a href="/calendar" class="nav-item {% if active_nav == 'calendar' %}active{% endif %}">
            <span class="nav-icon">&#128197;</span>
            Calendar
        </a>
        <a href="/chores-page" class="nav-item {% if active_nav == 'chores' %}active{% endif %}">
            <span class="nav-icon">&#9989;</span>
            Chores
        </a>
        <a href="/grocery" class="nav-item {% if active_nav == 'grocery' %}active{% endif %}">
            <span class="nav-icon">&#128722;</span>
            Grocery
        </a>
        <a href="/bank" class="nav-item {% if active_nav == 'bank' %}active{% endif %}">
            <span class="nav-icon">&#128176;</span>
            Bank
        </a>
        <a href="/missions" class="nav-item {% if active_nav == 'missions' %}active{% endif %}">
            <span class="nav-icon">&#127942;</span>
            Missions
        </a>
        <a href="/profile" class="nav-item {% if active_nav == 'profile' %}active{% endif %}">
            <span class="nav-icon">&#128100;</span>
            Profile
        </a>

        <!-- Available to cash out ticker -->
        <span class="nav-ticker" x-text="tickerDisplay">$0.000000</span>

        <!-- Current user + switch -->
        <a href="/session/logout" class="nav-user">
            <span class="nav-user-avatar">{{ current_user.icon if current_user.icon != 'question_mark' else '?' }}</span>
            <span>{{ current_user.username }}</span>
            <span class="nav-level-badge">Lv{{ current_user.level }}</span>
        </a>
    </nav>
    {% endif %}
    {% endblock %}

    <!-- Mission notification modal -->
    {% if current_user %}
    <template x-if="missionNotifications.length > 0">
      <div class="mission-notification-overlay" @click="dismissMissionNotifications()">
        <div class="mission-notification-modal" @click.stop>
          <span class="notification-trophy">&#127942;</span>
          <div class="notification-title">New Mission Assigned!</div>
          <template x-for="n in missionNotifications" :key="n.id">
            <span class="notification-mission-name" x-text="n.mission?.title"></span>
          </template>
          <div class="notification-actions">
            <a href="/missions" class="btn btn-accent">Go to Missions</a>
            <button class="btn btn-secondary" @click="dismissMissionNotifications()">Later</button>
          </div>
        </div>
      </div>
    </template>
    {% endif %}

    {% block scripts %}{% endblock %}

    <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('app', () => ({
            tickerDisplay: '$0.000000',
            _tickerSavings: 0,
            _tickerRate: 0.05,
            _tickerLastCredit: null,
            _tickerCashBalance: 0,
            _tickerUnlockedSavings: 0,
            _tickerRaf: null,
            idleTimer: null,
            idleTimeout: {{ idle_timeout_ms|default(300000) }},
            missionNotifications: [],

            init() {
                this.resetIdleTimer();
                document.addEventListener('pointerdown', () => this.resetIdleTimer());
                document.addEventListener('keydown', () => this.resetIdleTimer());

                {% if current_user %}
                this._startNavTicker();
                setInterval(() => this._syncNavTicker(), 30000);
                this._checkMissionNotifications();
                {% endif %}
            },

            async _startNavTicker() {
                try {
                    const res = await fetch('/api/bank/ticker');
                    if (!res.ok) return;
                    const data = await res.json();
                    this._tickerSavings = data.total_active_savings;
                    this._tickerRate = data.weekly_rate;
                    this._tickerLastCredit = data.last_interest_credit ? new Date(data.last_interest_credit) : null;
                    this._tickerCashBalance = data.cash_balance || 0;
                    this._tickerUnlockedSavings = data.unlocked_savings || 0;
                    if (this._tickerRaf) cancelAnimationFrame(this._tickerRaf);
                    this._tickNavTicker();
                } catch (e) {}
            },

            _tickNavTicker() {
                let interest = 0;
                if (this._tickerSavings > 0 && this._tickerLastCredit) {
                    const elapsed = (new Date() - this._tickerLastCredit) / 1000;
                    interest = this._tickerSavings * this._tickerRate * (elapsed / (7*24*60*60));
                }
                const total = this._tickerCashBalance + this._tickerUnlockedSavings + interest;
                this.tickerDisplay = '$' + total.toFixed(6);
                this._tickerRaf = requestAnimationFrame(() => this._tickNavTicker());
            },

            async _syncNavTicker() {
                try {
                    const res = await fetch('/api/bank/ticker');
                    if (!res.ok) return;
                    const data = await res.json();
                    this._tickerSavings = data.total_active_savings;
                    this._tickerRate = data.weekly_rate;
                    this._tickerLastCredit = data.last_interest_credit ? new Date(data.last_interest_credit) : null;
                    this._tickerCashBalance = data.cash_balance || 0;
                    this._tickerUnlockedSavings = data.unlocked_savings || 0;
                } catch (e) {}
            },

            resetIdleTimer() {
                clearTimeout(this.idleTimer);
                this.idleTimer = setTimeout(() => {
                    window.location.href = '/session/logout';
                }, this.idleTimeout);
            },

            handleVisibility() {
                if (document.visibilityState === 'visible') {
                    this.resetIdleTimer();
                }
            },

            async _checkMissionNotifications() {
                try {
                    const res = await fetch('/api/missions/notifications');
                    if (!res.ok) return;
                    const data = await res.json();
                    this.missionNotifications = data.notifications || [];
                } catch (e) {}
            },

            async dismissMissionNotifications() {
                try {
                    await fetch('/api/missions/notifications/dismiss', { method: 'POST' });
                } catch (e) {}
                this.missionNotifications = [];
            }
        }));
    });
    </script>
</body>
</html>
