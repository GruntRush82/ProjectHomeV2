{% extends "base.html" %}

{% block title %}Bank — Felker Family Hub{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
{% endblock %}

{% block content %}
<div x-data="bankApp" x-init="loadData()" x-cloak>

    <!-- Tab bar: Main / History -->
    <div class="bank-tabs">
        <button class="tab-btn" :class="{ active: tab === 'main' }" @click="tab = 'main'">Bank</button>
        <button class="tab-btn" :class="{ active: tab === 'history' }" @click="tab = 'history'; loadHistory()">History</button>
    </div>

    <!-- ═══════ MAIN TAB ═══════ -->
    <div x-show="tab === 'main'">

        <!-- Top hero: Cash Out + Lifestyle Points side by side -->
        <section class="bank-hero-row">
            <!-- Cash out side -->
            <div class="bank-cashout-section">
                <div class="bank-cashout-label">Available to cash out</div>
                <div class="bank-cashout-amount" x-text="'$' + cashoutDisplay"></div>
                <button class="btn-primary bank-cashout-btn"
                        @click="showCashoutModal = true"
                        :disabled="(cashBalance + unlockedSavings + accruedInterest) < cashoutMin">
                    Cash Out
                </button>
            </div>

            <!-- Lifestyle points side -->
            <div class="bank-lifestyle-hero" x-show="lifestyleLoaded">
                <div class="bank-lifestyle-hero-label">Lifestyle Points</div>
                <div class="bank-lifestyle-hero-points" x-text="lifestylePoints + ' ⭐'"></div>
                <button class="btn-lifestyle-rewards" @click="showRewardsModal = true">
                    Rewards &#10024;
                </button>
            </div>
        </section>

        <!-- Allowance note (compact, like fire mode) -->
        <section class="bank-allowance-note" x-show="allowance > 0">
            <span class="allowance-note-icon">&#128181;</span>
            <span class="allowance-note-text">
                Weekly allowance: <strong x-text="'$' + allowance.toFixed(2)"></strong>
                &nbsp;&middot;&nbsp; Full: <span x-text="'$' + allowance.toFixed(2)"></span>
                &nbsp;&middot;&nbsp; Half: <span x-text="'$' + (allowance / 2).toFixed(2)"></span>
            </span>
            <button class="btn-ghost btn-xs allowance-history-btn"
                    x-show="allowanceHistory.length > 0"
                    @click="showAllowanceHistory = !showAllowanceHistory"
                    x-text="showAllowanceHistory ? 'Hide' : 'History'"></button>
            <!-- Collapsible history -->
            <div x-show="showAllowanceHistory" x-cloak class="bank-allowance-history-inline">
                <template x-for="(txn, i) in allowanceHistory" :key="i">
                    <div class="ledger-row ledger-allowance">
                        <div class="ledger-icon">&#128181;</div>
                        <div class="ledger-details">
                            <div class="ledger-desc" x-text="txn.description || 'Weekly allowance'"></div>
                            <div class="ledger-date" x-text="formatDateTime(txn.created_at)"></div>
                        </div>
                        <div class="ledger-amount ledger-credit" x-text="'+$' + txn.amount.toFixed(2)"></div>
                    </div>
                </template>
            </div>
        </section>

        <!-- Fire Mode banner -->
        {% if current_user and current_user.fire_mode %}
        <section class="bank-fire-mode-banner">
            <span class="fire-mode-icon">&#128293;</span>
            <div class="fire-mode-info">
                <div class="fire-mode-title">FIRE MODE ACTIVE</div>
                <div class="fire-mode-bonus">+50% Allowance Boost &mdash; ${{ "%.2f"|format(current_user.allowance or 0) }} &rarr; ${{ "%.2f"|format((current_user.allowance or 0) * 1.5) }}</div>
            </div>
        </section>
        {% endif %}

        <!-- Cash + Savings overview row -->
        <div class="bank-overview-row">
            <!-- Savings Goal card (replaces cash balance) -->
            <section class="bank-card bank-goal-card">

                <!-- No goal: invite -->
                <div x-show="!goal && !showGoalForm" class="bank-goal-invite" @click="showGoalForm = true">
                    <div class="bank-goal-invite-icon">&#127775;</div>
                    <div class="bank-goal-invite-text">Set a savings goal</div>
                    <div class="bank-goal-invite-sub">What are you saving up for?</div>
                </div>

                <!-- Goal form (new or edit) -->
                <div x-show="showGoalForm" class="bank-goal-form-inline">
                    <div class="bank-goal-form-title" x-text="goal ? 'Edit Goal' : 'New Goal'"></div>
                    <input type="text" x-model="goalName"
                           placeholder="What are you saving for?"
                           class="form-input form-input-sm"
                           @keydown.enter="saveGoal()">
                    <input type="number" x-model.number="goalTarget"
                           placeholder="Target $"
                           class="form-input form-input-sm"
                           step="0.01" min="0" @keydown.enter="saveGoal()">
                    <div class="bank-goal-form-btns">
                        <button class="btn-ghost btn-sm" @click="showGoalForm = false; goalName=''; goalTarget=null">Cancel</button>
                        <button class="btn-primary btn-sm" @click="saveGoal()"
                                :disabled="!goalName.trim() || !goalTarget || goalTarget <= 0">Save</button>
                    </div>
                </div>

                <!-- Goal in progress -->
                <div x-show="goal && !showGoalForm && goalProgress < (goal?.target_amount || Infinity)" class="bank-goal-progress-state">
                    <div class="bank-goal-card-name" x-text="goal?.name"></div>
                    <div class="bank-goal-track-wrap">
                        <div class="bank-goal-track">
                            <div class="bank-goal-fill"
                                 :style="'width:' + Math.min(100, goalProgress / (goal?.target_amount || 1) * 100) + '%'"></div>
                        </div>
                        <div class="bank-goal-pct"
                             x-text="Math.floor(goalProgress / (goal?.target_amount || 1) * 100) + '%'"></div>
                    </div>
                    <div class="bank-goal-amounts">
                        <span class="bank-goal-current" x-text="'$' + goalProgress.toFixed(2)"></span>
                        <span class="bank-goal-sep">of</span>
                        <span class="bank-goal-target" x-text="'$' + (goal?.target_amount || 0).toFixed(2)"></span>
                    </div>
                    <div class="bank-goal-actions">
                        <button class="btn-ghost btn-xs"
                                @click="showGoalForm = true; goalName = goal.name; goalTarget = goal.target_amount">
                            Edit
                        </button>
                        <button class="btn-ghost btn-xs btn-danger-ghost"
                                @click="deleteGoal()">
                            &#10005; Delete
                        </button>
                    </div>
                </div>

                <!-- Goal COMPLETE: celebration state -->
                <div x-show="goal && !showGoalForm && goalProgress >= (goal?.target_amount || Infinity)"
                     class="bank-goal-complete-state"
                     x-init="if (goal && goalProgress >= (goal?.target_amount || Infinity)) goalCelebrate()">
                    <div class="bank-goal-trophy">&#127942;</div>
                    <div class="bank-goal-complete-title">YOU DID IT!</div>
                    <div class="bank-goal-complete-name" x-text="goal?.name"></div>
                    <div class="bank-goal-complete-bar">
                        <div class="bank-goal-complete-fill"></div>
                    </div>
                    <button class="btn-primary btn-sm bank-goal-clear-btn" @click="clearGoal()">
                        &#127881; I'm Ready! Clear Goal
                    </button>
                </div>

            </section>

            <!-- Savings card -->
            <section class="bank-card bank-savings-card">
                <div class="bank-card-label">Savings</div>
                <div class="bank-card-amount">
                    <span x-text="'$' + totalSavings.toFixed(2)"></span>
                    <span class="bank-interest-ticker" x-text="'+$' + accruedInterest.toFixed(6)"></span>
                </div>
                <div class="bank-projection" x-show="totalSavings > 0">
                    Yearly projection: <span x-text="'$' + yearlyProjection.toFixed(2)"></span>
                </div>

                <!-- Deposit form -->
                <div class="bank-deposit-form">
                    <input type="number" x-model.number="depositAmount"
                           :placeholder="'Min $' + depositMin.toFixed(2)"
                           class="form-input bank-deposit-input"
                           step="0.01" min="0">
                    <button class="btn-primary" @click="deposit()"
                            :disabled="!depositAmount || depositAmount < depositMin">
                        Deposit to Savings
                    </button>
                </div>
                <div class="bank-savings-cap" x-show="savingsMax > 0">
                    <span x-text="'$' + totalSavings.toFixed(2) + ' / $' + savingsMax.toFixed(2)"></span>
                    <div class="progress-track">
                        <div class="progress-fill" :style="'width:' + Math.min(100, totalSavings/savingsMax*100) + '%'"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Savings Deposits (Gold coins behind melting ice) -->
        <section class="bank-deposits-section" x-show="deposits.length > 0">
            <h2 class="section-title">Savings Deposits</h2>
            <div class="vault-grid">
                <template x-for="dep in deposits" :key="dep.id">
                    <div class="vault-item"
                         :class="{
                             'vault-locked': dep.locked,
                             'vault-unlocked': !dep.locked,
                             'vault-sm': dep.amount < 10,
                             'vault-md': dep.amount >= 10 && dep.amount < 50,
                             'vault-lg': dep.amount >= 50
                         }">
                        <!-- Gold coins layer (always visible, behind ice) -->
                        <div class="vault-coins">
                            <span class="coin coin-1">&#129689;</span>
                            <span class="coin coin-2">&#129689;</span>
                            <span class="coin coin-3" x-show="dep.amount >= 10">&#129689;</span>
                            <span class="coin coin-4" x-show="dep.amount >= 50">&#129689;</span>
                        </div>
                        <!-- Ice overlay — SVG crystal + shimmer + drip -->
                        <div class="vault-ice"
                             x-show="dep.locked"
                             :style="`--melt:${dep.melt_percent/100}; opacity:${1 - dep.melt_percent/100*0.8}; backdrop-filter:blur(${Math.max(0,10-dep.melt_percent/100*10)}px)`">
                            <div class="ice-crystal-container">
                                <!-- 6-pointed SVG ice crystal -->
                                <svg class="ice-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <defs>
                                        <radialGradient id="iceg" cx="50%" cy="50%" r="50%">
                                            <stop offset="0%"   stop-color="rgba(255,255,255,0.92)"/>
                                            <stop offset="35%"  stop-color="rgba(210,240,255,0.75)"/>
                                            <stop offset="100%" stop-color="rgba(160,210,240,0)"/>
                                        </radialGradient>
                                    </defs>
                                    <!-- Arm group — repeated 6 times with 60° rotation -->
                                    <g stroke="rgba(200,235,255,0.85)" stroke-linecap="round" fill="none">
                                        <g transform="rotate(0 50 50)">
                                            <line x1="50" y1="50" x2="50" y2="8"  stroke-width="2.2"/>
                                            <line x1="50" y1="36" x2="43" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="36" x2="57" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="22" x2="44" y2="16" stroke-width="1.0"/>
                                            <line x1="50" y1="22" x2="56" y2="16" stroke-width="1.0"/>
                                        </g>
                                        <g transform="rotate(60 50 50)">
                                            <line x1="50" y1="50" x2="50" y2="8"  stroke-width="2.2"/>
                                            <line x1="50" y1="36" x2="43" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="36" x2="57" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="22" x2="44" y2="16" stroke-width="1.0"/>
                                            <line x1="50" y1="22" x2="56" y2="16" stroke-width="1.0"/>
                                        </g>
                                        <g transform="rotate(120 50 50)">
                                            <line x1="50" y1="50" x2="50" y2="8"  stroke-width="2.2"/>
                                            <line x1="50" y1="36" x2="43" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="36" x2="57" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="22" x2="44" y2="16" stroke-width="1.0"/>
                                            <line x1="50" y1="22" x2="56" y2="16" stroke-width="1.0"/>
                                        </g>
                                        <g transform="rotate(180 50 50)">
                                            <line x1="50" y1="50" x2="50" y2="8"  stroke-width="2.2"/>
                                            <line x1="50" y1="36" x2="43" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="36" x2="57" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="22" x2="44" y2="16" stroke-width="1.0"/>
                                            <line x1="50" y1="22" x2="56" y2="16" stroke-width="1.0"/>
                                        </g>
                                        <g transform="rotate(240 50 50)">
                                            <line x1="50" y1="50" x2="50" y2="8"  stroke-width="2.2"/>
                                            <line x1="50" y1="36" x2="43" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="36" x2="57" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="22" x2="44" y2="16" stroke-width="1.0"/>
                                            <line x1="50" y1="22" x2="56" y2="16" stroke-width="1.0"/>
                                        </g>
                                        <g transform="rotate(300 50 50)">
                                            <line x1="50" y1="50" x2="50" y2="8"  stroke-width="2.2"/>
                                            <line x1="50" y1="36" x2="43" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="36" x2="57" y2="29" stroke-width="1.4"/>
                                            <line x1="50" y1="22" x2="44" y2="16" stroke-width="1.0"/>
                                            <line x1="50" y1="22" x2="56" y2="16" stroke-width="1.0"/>
                                        </g>
                                    </g>
                                    <!-- Center hexagon -->
                                    <polygon points="50,44 55.5,47 55.5,53 50,56 44.5,53 44.5,47"
                                             fill="url(#iceg)"
                                             stroke="rgba(200,235,255,0.9)" stroke-width="0.8"/>
                                </svg>
                                <div class="ice-shimmer"></div>
                                <div class="ice-drip ice-drip-1" x-show="dep.melt_percent > 40"></div>
                                <div class="ice-drip ice-drip-2" x-show="dep.melt_percent > 65"></div>
                            </div>
                            <!-- SVG fracture lines -->
                            <svg class="ice-fractures" viewBox="0 0 100 100" x-show="dep.melt_percent > 25">
                                <polyline points="20,35 32,42 38,38 50,48"
                                          stroke="white" stroke-width="0.8" fill="none" stroke-opacity="0.6"/>
                                <polyline points="62,24 67,38 74,34 82,44"
                                          stroke="white" stroke-width="0.8" fill="none" stroke-opacity="0.5"/>
                                <polyline points="15,62 28,56 35,70"
                                          stroke="white" stroke-width="0.7" fill="none" stroke-opacity="0.4"
                                          x-show="dep.melt_percent > 50"/>
                            </svg>
                        </div>
                        <!-- Unlocked golden glow -->
                        <div class="vault-glow" x-show="!dep.locked"></div>
                        <!-- Info overlay -->
                        <div class="vault-info">
                            <div class="vault-amount" x-text="'$' + dep.amount.toFixed(2)"></div>
                            <div class="vault-date" x-text="formatDate(dep.deposited_at)"></div>
                        </div>
                        <!-- Progress bar (melt meter) -->
                        <div class="vault-progress" x-show="dep.locked">
                            <div class="vault-progress-fill"
                                 :style="'width:' + dep.melt_percent + '%'"></div>
                        </div>
                        <div class="vault-timer" x-show="dep.locked"
                             x-text="formatLock(dep.lock_seconds_remaining)"></div>
                        <button class="vault-withdraw-btn" x-show="!dep.locked"
                                @click="withdrawDeposit(dep.id)">
                            Withdraw
                        </button>
                    </div>
                </template>
            </div>
        </section>

        <!-- Stats -->
        <section class="bank-card bank-stats">
            <h2 class="section-title">Stats</h2>
            <div class="bank-stat-row">
                <span class="bank-stat-label">Total Cashed Out</span>
                <span class="bank-stat-value" x-text="'$' + totalCashedOut.toFixed(2)"></span>
            </div>
            <div class="bank-stat-row">
                <span class="bank-stat-label">Total Interest Earned</span>
                <span class="bank-stat-value" x-text="'$' + totalInterestEarned.toFixed(2)"></span>
            </div>
        </section>

    </div>

    <!-- ═══════ LIFESTYLE REWARDS MODAL ═══════ -->
    <div class="modal-overlay" x-show="showRewardsModal" x-cloak @click.self="showRewardsModal = false">
        <div class="modal-card modal-card-wide">
            <div class="modal-header-row">
                <h2 class="modal-title">&#11088; Lifestyle Rewards</h2>
                <div class="lifestyle-modal-balance">
                    <span class="lifestyle-modal-pts" x-text="lifestylePoints"></span>
                    <span class="lifestyle-modal-pts-label">pts</span>
                </div>
            </div>

            <!-- Privileges shop -->
            <div x-show="lifestylePrivileges.length === 0" class="empty-state">No rewards available yet</div>
            <div class="lifestyle-rewards-grid">
                <template x-for="priv in lifestylePrivileges" :key="priv.id">
                    <div class="lifestyle-reward-card" :class="{ 'reward-affordable': lifestylePoints >= priv.point_cost }">
                        <div class="reward-info">
                            <div class="reward-name" x-text="priv.name"></div>
                            <div class="reward-desc" x-show="priv.description" x-text="priv.description"></div>
                        </div>
                        <div class="reward-footer">
                            <span class="reward-cost" x-text="priv.point_cost + ' pt' + (priv.point_cost !== 1 ? 's' : '')"></span>
                            <button class="btn-primary btn-sm"
                                    @click="redeemPrivilege(priv.id, priv.point_cost)"
                                    :disabled="lifestylePoints < priv.point_cost">
                                Redeem
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Pending redemptions -->
            <div x-show="pendingRedemptions.length > 0" class="lifestyle-pending-section">
                <h3 class="lifestyle-pending-title">&#8987; Pending</h3>
                <template x-for="r in pendingRedemptions" :key="r.id">
                    <div class="lifestyle-pending-row">
                        <span x-text="r.privilege_name"></span>
                        <span class="redemption-badge pending">Pending</span>
                    </div>
                </template>
            </div>

            <div class="modal-actions">
                <button class="btn-ghost" @click="showRewardsModal = false">Close</button>
            </div>
        </div>
    </div>

    <!-- ═══════ HISTORY TAB ═══════ -->
    <div x-show="tab === 'history'">
        <section class="bank-card">
            <h2 class="section-title">Transaction History</h2>
            <div x-show="transactions.length === 0" class="empty-state">No transactions yet</div>
            <div class="bank-ledger">
                <template x-for="txn in transactions" :key="txn.id">
                    <div class="ledger-row" :class="'ledger-' + txn.type">
                        <div class="ledger-icon" x-text="txnIcon(txn.type)"></div>
                        <div class="ledger-details">
                            <div class="ledger-desc" x-text="txn.description || txn.type"></div>
                            <div class="ledger-date" x-text="formatDateTime(txn.created_at)"></div>
                        </div>
                        <div class="ledger-amount" :class="{ 'ledger-credit': txn.amount > 0, 'ledger-debit': txn.amount < 0 }"
                             x-text="(txn.amount > 0 ? '+' : '') + '$' + Math.abs(txn.amount).toFixed(2)"></div>
                    </div>
                </template>
            </div>
            <!-- Pagination -->
            <div class="bank-pagination" x-show="historyPages > 1">
                <button class="btn-ghost btn-sm" @click="historyPage--; loadHistory()"
                        :disabled="historyPage <= 1">&laquo; Prev</button>
                <span class="bank-page-info" x-text="'Page ' + historyPage + ' of ' + historyPages"></span>
                <button class="btn-ghost btn-sm" @click="historyPage++; loadHistory()"
                        :disabled="historyPage >= historyPages">Next &raquo;</button>
            </div>
        </section>
    </div>

    <!-- ═══════ CASHOUT MODAL ═══════ -->
    <div class="modal-overlay" x-show="showCashoutModal" x-cloak @click.self="showCashoutModal = false">
        <div class="modal-card">
            <h2>Cash Out</h2>
            <p class="modal-amount" x-text="'$' + cashoutDisplay"></p>
            <div class="modal-breakdown" x-show="unlockedSavings > 0">
                <div>Cash: <span x-text="'$' + cashBalance.toFixed(2)"></span></div>
                <div>Unlocked savings: <span x-text="'$' + unlockedSavings.toFixed(2)"></span></div>
            </div>
            <p class="modal-note">This will send an email confirmation. Show it to collect your payout!</p>
            <div class="modal-actions">
                <button class="btn-ghost" @click="showCashoutModal = false">Cancel</button>
                <button class="btn-primary" @click="doCashout()" :disabled="cashingOut">
                    <span x-show="!cashingOut">Confirm Cash Out</span>
                    <span x-show="cashingOut">Processing...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Flash message -->
    <div class="bank-flash" x-show="flashMsg" x-cloak
         x-transition:enter="flash-enter"
         x-transition:leave="flash-leave"
         :class="flashType"
         x-text="flashMsg"></div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('bankApp', () => ({
        tab: 'main',
        // Account data
        cashBalance: 0,
        totalSavings: 0,
        unlockedSavings: 0,
        cashoutAvailable: 0,
        yearlyProjection: 0,
        totalCashedOut: 0,
        totalInterestEarned: 0,
        deposits: [],
        goal: null,
        // Allowance
        allowance: 0,
        allowanceHistory: [],
        showAllowanceHistory: false,
        // Config
        savingsMax: 100,
        depositMin: 1,
        cashoutMin: 1,
        // Interest ticker
        accruedInterest: 0,
        cashoutDisplay: '0.00',
        tickerSavings: 0,
        tickerRate: 0.05,
        tickerLastCredit: null,
        tickerRaf: null,
        // UI state
        depositAmount: null,
        showCashoutModal: false,
        showRewardsModal: false,
        cashingOut: false,
        showGoalForm: false,
        goalName: '',
        goalTarget: null,
        goalProgress: 0,
        goalCelebrated: false,
        flashMsg: '',
        flashType: 'success',
        // History
        transactions: [],
        historyPage: 1,
        historyPages: 1,
        // Lifestyle
        lifestylePoints: 0,
        lifestylePrivileges: [],
        pendingRedemptions: [],
        lifestyleLoaded: false,

        async loadData() {
            try {
                const res = await fetch('/api/bank/overview');
                if (!res.ok) return;
                const data = await res.json();

                this.cashBalance = data.account.cash_balance;
                this.totalSavings = data.total_savings;
                this.unlockedSavings = data.unlocked_savings;
                this.cashoutAvailable = data.cashout_available;
                this.yearlyProjection = data.yearly_projection;
                this.totalCashedOut = data.account.total_cashed_out;
                this.totalInterestEarned = data.account.total_interest_earned;
                this.deposits = data.deposits;
                this.goal = data.goal;
                this.savingsMax = data.savings_max;
                this.depositMin = data.savings_deposit_min;
                this.cashoutMin = data.cashout_min;
                this.allowance = data.allowance || 0;
                this.allowanceHistory = data.allowance_history || [];
                this.goalProgress = data.goal_progress || 0;

                // Start interest ticker
                this.startTicker();
                // Load lifestyle data
                this.loadLifestyle();
            } catch (e) {
                console.error('Failed to load bank data:', e);
            }
        },

        async startTicker() {
            try {
                const res = await fetch('/api/bank/ticker');
                if (!res.ok) return;
                const data = await res.json();

                this.tickerSavings = data.total_active_savings;
                this.tickerRate = data.weekly_rate;
                this.tickerLastCredit = data.last_interest_credit ? new Date(data.last_interest_credit) : new Date();
                this.accruedInterest = data.accrued_interest;

                // Start animation loop
                if (this.tickerRaf) cancelAnimationFrame(this.tickerRaf);
                this.tickInterest();

                // Sync every 30 seconds
                setInterval(() => this.syncTicker(), 30000);
            } catch (e) {
                console.error('Ticker init failed:', e);
            }
        },

        tickInterest() {
            if (this.tickerSavings > 0 && this.tickerLastCredit) {
                const now = new Date();
                const elapsed = (now - this.tickerLastCredit) / 1000;
                const secondsPerWeek = 7 * 24 * 60 * 60;
                this.accruedInterest = this.tickerSavings * this.tickerRate * (elapsed / secondsPerWeek);
            }
            // Cashout available = cash + unlocked savings + accrued interest, penny precision
            const total = this.cashBalance + this.unlockedSavings + this.accruedInterest;
            this.cashoutDisplay = (Math.floor(total * 100) / 100).toFixed(2);
            this.tickerRaf = requestAnimationFrame(() => this.tickInterest());
        },

        async syncTicker() {
            try {
                const res = await fetch('/api/bank/ticker');
                if (!res.ok) return;
                const data = await res.json();
                this.tickerSavings = data.total_active_savings;
                this.tickerRate = data.weekly_rate;
                this.tickerLastCredit = data.last_interest_credit ? new Date(data.last_interest_credit) : new Date();
            } catch (e) {}
        },

        async deposit() {
            if (!this.depositAmount || this.depositAmount < this.depositMin) return;
            try {
                const res = await fetch('/bank/savings/deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: this.depositAmount })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }

                this.depositAmount = null;
                this.flash('Deposited to savings!', 'success');
                this.loadData();
            } catch (e) {
                this.flash('Deposit failed', 'error');
            }
        },

        async doCashout() {
            this.cashingOut = true;
            try {
                const res = await fetch('/bank/cashout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); this.cashingOut = false; return; }

                this.showCashoutModal = false;
                this.cashingOut = false;
                this.flash('Cashed out $' + data.cashed_out.toFixed(2) + '! Check your email.', 'success');

                // Celebration
                if (typeof confetti === 'function') {
                    confetti({ particleCount: 300, spread: 140, origin: { y: 0.4 } });
                }
                this.loadData();
                // Refresh the nav ticker immediately so it doesn't lag behind
                window.dispatchEvent(new CustomEvent('bank:refresh-ticker'));
            } catch (e) {
                this.cashingOut = false;
                this.flash('Cashout failed', 'error');
            }
        },

        async withdrawDeposit(depositId) {
            try {
                const res = await fetch(`/bank/savings/withdraw/${depositId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }

                this.flash('Withdrew $' + data.withdrawn.toFixed(2) + '! Check your email.', 'success');
                if (typeof confetti === 'function') {
                    confetti({ particleCount: 150, spread: 100, origin: { y: 0.5 } });
                }
                this.loadData();
            } catch (e) {
                this.flash('Withdrawal failed', 'error');
            }
        },

        async saveGoal() {
            if (!this.goalName.trim() || !this.goalTarget || this.goalTarget <= 0) return;
            try {
                const res = await fetch('/bank/savings/goal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: this.goalName.trim(), target_amount: this.goalTarget })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error, 'error'); return; }

                this.goal = data;
                this.goalCelebrated = false;
                this.showGoalForm = false;
                this.goalName = '';
                this.goalTarget = null;
                this.flash('Goal saved!', 'success');
            } catch (e) {
                this.flash('Failed to save goal', 'error');
            }
        },

        async clearGoal() {
            try {
                const res = await fetch('/bank/savings/goal/clear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!res.ok) return;
                this.goal = null;
                this.goalProgress = 0;
                this.goalCelebrated = false;
                this.flash('Goal cleared! Set a new one.', 'success');
            } catch (e) {
                this.flash('Failed to clear goal', 'error');
            }
        },

        async deleteGoal() {
            try {
                const res = await fetch('/bank/savings/goal', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!res.ok) return;
                this.goal = null;
                this.goalProgress = 0;
                this.goalCelebrated = false;
                this.flash('Goal removed.', 'success');
            } catch (e) {
                this.flash('Failed to delete goal', 'error');
            }
        },

        goalCelebrate() {
            if (this.goalCelebrated) return;
            this.goalCelebrated = true;
            if (typeof confetti === 'function') {
                confetti({ particleCount: 200, spread: 120, origin: { y: 0.5 } });
            }
        },

        async loadHistory() {
            try {
                const res = await fetch(`/bank/transactions?page=${this.historyPage}&per_page=20`);
                if (!res.ok) return;
                const data = await res.json();
                this.transactions = data.transactions;
                this.historyPages = data.pages;
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        },

        async loadLifestyle() {
            try {
                const [privRes, redemRes] = await Promise.all([
                    fetch('/api/lifestyle/privileges'),
                    fetch('/api/lifestyle/redemptions'),
                ]);
                if (privRes.ok) {
                    const pd = await privRes.json();
                    this.lifestylePrivileges = pd.privileges || [];
                }
                if (redemRes.ok) {
                    const rd = await redemRes.json();
                    const all = rd.redemptions || [];
                    this.pendingRedemptions = all.filter(r => r.status === 'pending');
                    // Get lifestyle points from profile endpoint
                    const profileRes = await fetch('/api/profile');
                    if (profileRes.ok) {
                        const profile = await profileRes.json();
                        this.lifestylePoints = profile.lifestyle_points || 0;
                    }
                }
            } catch (e) {
                console.error('Failed to load lifestyle data:', e);
            }
            this.lifestyleLoaded = true;
        },

        async redeemPrivilege(privilegeId, cost) {
            if (this.lifestylePoints < cost) {
                this.flash('Not enough points', 'error');
                return;
            }
            try {
                const res = await fetch('/api/lifestyle/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ privilege_id: privilegeId })
                });
                const data = await res.json();
                if (!res.ok) { this.flash(data.error || 'Redemption failed', 'error'); return; }
                this.lifestylePoints -= cost;
                this.pendingRedemptions.push(data.redemption);
                this.flash('Redeemed! Check pending below.', 'success');
            } catch (e) {
                this.flash('Redemption failed', 'error');
            }
        },

        flash(msg, type = 'success') {
            this.flashMsg = msg;
            this.flashType = type;
            setTimeout(() => { this.flashMsg = ''; }, 4000);
        },

        txnIcon(type) {
            const icons = {
                allowance: '\u{1F4B5}',
                cashout: '\u{1F4B8}',
                savings_deposit: '\u{1F48E}',
                savings_withdrawal: '\u{1F4A0}',
                interest: '\u{1F4C8}',
                mission_reward: '\u{1F3C6}',
            };
            return icons[type] || '\u{1F4B0}';
        },

        formatDate(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        },

        formatDateTime(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        },

        formatLock(seconds) {
            if (!seconds || seconds <= 0) return 'Unlocked!';
            const days = Math.floor(seconds / 86400);
            const hrs = Math.floor((seconds % 86400) / 3600);
            if (days > 0) return days + 'd ' + hrs + 'h';
            const mins = Math.floor((seconds % 3600) / 60);
            return hrs + 'h ' + mins + 'm';
        }
    }));
});
</script>
{% endblock %}
